МІНІСТЕРСТВО ОСВІТИ І НАУКИ УКРАЇНИ
ХАРКІВСЬКИЙ НАЦІОНАЛЬНИЙ УНІВЕРСИТЕТ РАДІОЕЛЕКТРОНІКИ


КАФЕДРА ПРОГРАМНОЇ ІНЖЕНЕРІЇ




Звіт
з лабораторної роботи № 2 з дисципліни
Аналіз та рефакторинг коду





Виконав:                                                                 Перевірив:
ст. гр. ПЗПІ-23-4                				ст. викладач кафедри ПІ
Єрмоленко Олександр					Сокорчук Ігор Петрович

























Харків 2025


ІСТОРІЯ ЗМІН
      №
      Дата
Версія звіту
      Опис змін та виправлень
      1
      09.01.2026
      0.1
      Початкова версія

      




1 ЗАВДАННЯ

1. Розробити будову програмної системи.
2. Створити UML діаграму прецедентів для серверної частини системи.
3. Створити ER діаграму даних.
4. Розробити базу даних (БД) програмної системи.
5. Створити діаграму структури БД.
6. Розробити функції роботи з БД.
7. Розробити API (REST) для взаємодії серверної частини з клієнтами.
8. Створити специфікацію розробленого API.
9. Створити програмну реалізацію розробленого API та функцій роботи з БД.


2 ОПИС ВИКОНАНОЇ РОБОТИ

	Програмна система реалізована як серверна частина у вигляді REST API-додатку для централізованого керування доступом до приміщень, адміністрування прав користувачів та моніторингу стану IoT-пристроїв (розумних замків). Для розробки використано платформу Node.js та фреймворк Express.js, а як систему управління базами даних обрано PostgreSQL. Взаємодія з базою здійснюється через потужний Prisma ORM, що забезпечує автоматизацію міграцій та зручну роботу зі зв’язками між сутностями. Аутентифікація користувачів реалізована за допомогою JWT-токенів, які передаються в заголовках HTTP-запитів, забезпечуючи захист приватних маршрутів і розмежування доступу відповідно до ролей (Super Admin, Org Admin, Manager, Tenant, Security, Maintenance (див. дод. Б)).
     Система складається з кількох ключових функціональних модулів (див. дод. Б). Модуль адміністрування відповідає за управління користувачами та призначення ролей. Модуль "Інфраструктури" дозволяє керувати ієрархією об'єктів: будівлями (buildings), приміщеннями (rooms) та прив'язаними до них пристроями. Модуль контролю доступу (Access Control) відповідає за генерацію та видачу цифрових ключів (access_keys), валідацію прав доступу в реальному часі та підтримку офлайн-авторизації через алгоритм TOTP. Також реалізовано модуль аудиту, який веде детальний журнал подій (event_logs) про всі спроби входу, відмови та системні помилки.
     Для фізичної взаємодії з дверима використовуються IoT-пристрої (розумні замки та датчики руху), що передають дані про стан механізму, положення дверей та рівень заряду батареї. Телеметрія від пристроїв передається через протокол MQTT на брокер повідомлень (Mosquitto), звідки вона потрапляє на сервер для обробки. Система включає модуль аналітики, який використовує математичні алгоритми: лінійну регресію для прогнозування часу розряду батарей (Predictive Maintenance) та Z-Score для виявлення аномалій у поведінці користувачів або пристроїв. Це дозволяє оперативно реагувати на критичні ситуації, такі як спроби злому або втрата зв'язку, генеруючи відповідні алерти.
     ER-діаграма (див. дод. Б) системи побудована з урахуванням нормалізації даних та вимог бізнес-логіки. Основними сутностями є: Будівлі (buildings), Кімнати (rooms), Пристрої (devices), Користувачі (users), Ключі доступу (access_keys) та Журнал подій (event_logs). Реалізовано чітку ієрархію: одна будівля містить багато кімнат, кожна кімната може мати один або кілька пристроїв (зв'язок one-to-many). Ключовою особливістю є використання гнучкого поля конфігурації для пристроїв, що дозволяє зберігати специфічні налаштування без зміни схеми БД.
     Фізична модель бази даних відображає точні типи даних PostgreSQL: використання UUID для первинних ключів (що забезпечує унікальність у розподілених системах), JSONB для зберігання неструктурованих налаштувань (config) та метаданих подій, а також TIMESTAMP WITH TIME ZONE для точної фіксації часу телеметрії. Широко використовуються ENUM типи для статусів пристроїв (ONLINE, OFFLINE), типів подій (ACCESS_GRANTED, SECURITY_BREACH) та ролей користувачів. Завдяки Prisma ORM, механізм вкладених запитів (include) дозволяє ефективно отримувати повну інформацію про інфраструктуру, наприклад, стан всіх замків у конкретній будівлі разом з активними алертами.
     Документація API інтегрована безпосередньо в код за допомогою бібліотек swagger-jsdoc та swagger-ui-express. Це дозволяє автоматично генерувати актуальну інтерактивну документацію (доступну також у форматі JSON), де описані всі ендпоінти, схеми запитів/відповідей та методи авторизації. Такий підхід значно спрощує тестування API, розробку клієнтських мобільних додатків та інтеграцію з IoT-компонентами.


4 ВИСНОВКИ
     
     Розроблена програмна система забезпечує централізоване керування контролем доступу та моніторинг безпеки приміщень завдяки реалізації серверної частини у вигляді REST API-додатку на базі Node.js та Express.js. Використання PostgreSQL у поєднанні з Prisma ORM дозволяє ефективно та безпечно працювати з реляційною базою даних, реалізовуючи всі операції CRUD і підтримуючи складні запити з глибокими вкладеними зв’язками між ієрархією будівель, IoT-пристроями, цифровими ключами та журналом подій.
Модульна архітектура, побудована за принципом Routes-Controllers-Services, гарантує чіткий поділ відповідальностей між обробкою HTTP-запитів, бізнес-логікою та взаємодією з апаратним забезпеченням, що підвищує зрозумілість та підтримуваність коду. Автоматизація процесів безпеки, безперервний збір телеметрії (напруга батареї, рівень сигналу RSSI, фізичний стан дверей) через MQTT-брокер та інтелектуальний аналіз даних (прогнозування відмови живлення, виявлення аномалій за допомогою Z-Score), дозволяє підтримувати безперебійну роботу системи та своєчасно сповіщати службу охорони або техперсонал про спроби злому чи технічні несправності.
     Система реалізує гнучку рольову модель (RBAC) з диференційованими рівнями доступу (Super Admin, Org Admin, Manager, Security, Maintenance, Tenant), що забезпечує суворий контроль за інфраструктурою, безпечну видачу прав доступу та ведення прозорого аудиту дій. Інтерактивна документація API, автоматично згенерована за допомогою Swagger (OpenAPI), спрощує роботу розробників мобільних клієнтів та інтеграцію мікроконтролерів замків, надаючи повний опис захищених ендпоінтів, приклади валідації TOTP-кодів та схеми обміну даними.





ДОДАТОК А

Графічні матеріали


Рисунок 1 — ER-діаграма


Рисунок 2 — Діаграма бази даних

Рисунок 3 — UML діаграма прецедентів








ДОДАТОК Б

Специфікація REST API системи Smart Lock
Протокол: HTTP/1.1 Формат обміну даними: JSON (application/json) Базовий URL: /api Автентифікація: Authorization: Bearer <JWT_TOKEN>
1. Автентифікація та Користувачі (Auth & Users)
* POST /auth/register
o Роль: Public (Публічний доступ)
o Опис: Реєстрація нового користувача (за замовчуванням отримує роль TENANT).
o Тіло запиту: { email, password, fullName }
* POST /auth/login
o Роль: Public
o Опис: Вхід у систему. Повертає JWT токен доступу.
o Тіло запиту: { email, password }
* GET /auth/me
o Роль: Auth (Будь-який авторизований користувач)
o Опис: Отримати профіль поточного користувача.
* GET /users
o Роль: Admin+
o Опис: Отримати список усіх користувачів системи.
* PATCH /users/:id/role
o Роль: Super Admin
o Опис: Змінити роль користувача (наприклад, підвищити до Менеджера).
o Тіло запиту: { role: "MANAGER" }
2. Інфраструктура (Buildings & Rooms)
* GET /buildings
o Роль: Staff (Персонал: Admin, Manager, Maint, Security)
o Опис: Список будівель.
* POST /buildings
o Роль: Admin
o Опис: Створити нову будівлю.
o Тіло запиту: { name, address, managerId }
* GET /buildings/:id
o Роль: Auth
o Опис: Деталі конкретної будівлі (включно зі списком кімнат).
* GET /rooms
o Роль: Staff
o Опис: Список кімнат у конкретній будівлі.
o Параметри: ?buildingId=UUID
* POST /rooms
o Роль: Admin, Manager
o Опис: Додати нову кімнату до будівлі.
o Тіло запиту: { name, buildingId, floorNumber, isRestricted }
3. Пристрої та IoT (Devices)
* GET /devices
o Роль: Staff
o Опис: Отримати список пристроїв. Можлива фільтрація.
o Параметри: ?status=ONLINE&category=SMART_LOCK
* POST /devices
o Роль: Admin, Maintenance
o Опис: Реєстрація нового IoT-пристрою в системі.
o Тіло запиту: { serialNumber, roomId, category, config }
* PUT /devices/:id/config
o Роль: Admin, Maintenance
o Опис: Оновлення налаштувань пристрою (гучність, автозакриття).
o Тіло запиту: { config: { volume: 80 } }
* GET /devices/:id/secret
o Роль: Super Admin
o Опис: Отримати TOTP-секрет (для прошивки пристрою або генерації QR-коду).
* POST /devices/:id/open
o Роль: Tenant+ (Мешканці та Персонал)
o Опис: Віддалене відкриття дверей. Надсилає команду OPEN через MQTT.
* POST /devices/:id/lock
o Роль: Tenant+
o Опис: Примусове закриття дверей. Надсилає команду LOCK через MQTT.
4. Контроль доступу (Access Control)
* POST /access-keys/issue
o Роль: Manager+
o Опис: Видати цифровий ключ користувачу на певний період.
o Тіло запиту: { userId, deviceId, validFrom, validTo }
* GET /access-keys/my
o Роль: Auth
o Опис: Отримати список моїх активних ключів доступу.
* DELETE /access-keys/:id
o Роль: Manager+
o Опис: Відкликати ключ (заборонити доступ достроково).
* POST /access-keys/verify-pin
o Роль: Public / IoT
o Опис: Валідація TOTP коду. Емуляція введення коду на клавіатурі замка.
o Тіло запиту: { deviceId, code: "123456" }
5. Моніторинг та Аналітика (Monitoring)
* POST /telemetry
o Роль: Admin / IoT Service Account
o Опис: Завантаження пакету телеметрії (HTTP fallback, якщо MQTT недоступний).
o Тіло запиту: { deviceId, voltage, percentage, payload }
* GET /logs
o Роль: Security+
o Опис: Перегляд журналу подій (Audit Log).
o Параметри: ?deviceId=UUID&type=ACCESS_DENIED
* GET /alerts
o Роль: Staff
o Опис: Список активних тривог (Battery, Security, Connection).
o Параметри: ?status=NEW
* PATCH /alerts/:id/read
o Роль: Staff
o Опис: Позначити тривогу як прочитану (Archive).
* GET /analytics/battery/:id
o Роль: Maintenance
o Опис: Отримати прогноз дати відмови батареї (Linear Regression).
* GET /analytics/risk/:userId
o Роль: Security
o Опис: Отримати оцінку підозрілої поведінки користувача (Z-Score).
6. Системні (System)
* GET /dashboard
o Роль: Auth
o Опис: Отримати зведену статистику. Структура відповіді залежить від ролі користувача.
* GET /backups/export
o Роль: Super Admin
o Опис: Завантажити повний дамп бази даних у форматі JSON.
* POST /backups/import
o Роль: Super Admin
o Опис: Відновити базу даних з JSON файлу.
o Тіло запиту: multipart/form-data з полем file.
* GET /api-docs
o Роль: Public
o Опис: Інтерактивна документація Swagger UI.
* GET /health
o Роль: Public
o Опис: Перевірка працездатності сервера (Health Check).


2


