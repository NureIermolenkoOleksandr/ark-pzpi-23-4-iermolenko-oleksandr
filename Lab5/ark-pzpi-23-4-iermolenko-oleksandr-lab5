МІНІСТЕРСТВО ОСВІТИ І НАУКИ УКРАЇНИ
ХАРКІВСЬКИЙ НАЦІОНАЛЬНИЙ УНІВЕРСИТЕТ РАДІОЕЛЕКТРОНІКИ


КАФЕДРА ПРОГРАМНОЇ ІНЖЕНЕРІЇ




Звіт
з лабораторної роботи № 5 з дисципліни
Аналіз та рефакторинг коду










Виконав:                                                               	Перевірив:
ст. гр. ПЗПІ-23-4                				ст. викладач кафедри ПІ
Єрмоленко Олександр					Сокорчук Ігор Петрович
	




















Харків 2025


1 ІСТОРІЯ ЗМІН
      №
      Дата
Версія звіту
Опис змін та виправлень
      1
      10.01.2026
      0.1
      Початкова версія

      




2 ЗАВДАННЯ

1. Розгорнути створену програмну систему: Використовуючи інструменти для розгортання (наприклад, Docker, Kubernetes, хмарні сервіси), розгорнути серверну частину, веб-клієнт, мобільний клієнт та IoT клієнт. Налаштувати середовище для роботи програмної системи (сервер, база даних, мережеві налаштування).
2. Перевірити та налаштувати роботу розгорнутої програмної системи: Провести перевірку стабільності та коректності роботи усіх компонентів програмної системи (серверна частина, IoT клієнт, база даних,  API). Виконати налаштування параметрів серверної частини, клієнтських  застосунків та мережевих протоколів для коректної роботи системи.
3. Продемонструвати описану у розділі 2.2 Vision & Scope функціональність програмної системи: Описати та продемонструвати всі функції, передбачені в розділі  2.2 Vision & Scope, включаючи бізнес логіку, функції адміністрування та  взаємодію між серверною частиною та клієнтами. Перевірити реалізацію всіх необхідних функціональних можливостей програмної системи

3 ОПИС ВИКОНАНОЇ РОБОТИ

     Система Smart Lock складається з декількох контейнерів, які взаємодіють у межах однієї віртуальної мережі Docker (smart-lock-net) для забезпечення безпечного контролю доступу, зберігання даних та двостороннього зв'язку з пристроями.
     Перший компонент - це Node.js бекенд (api), який відповідає за REST API, бізнес-логіку доступу та збереження даних у базі PostgreSQL (див. docker-compose.yml). Контейнер піднімається з локальної збірки на базі образу node:18-alpine, прокидає порт 3000 на хост та отримує змінні середовища для підключення до бази даних (DATABASE_URL), адресу MQTT-брокера (MQTT_BROKER_URL) та секрет для підпису токенів (JWT_SECRET). Для коректної роботи ORM Prisma в середовищі Alpine додатково встановлюється бібліотека OpenSSL. Контейнер залежить від сервісів postgres та mosquitto, гарантуючи, що інфраструктура готова до прийому з'єднань перед стартом сервера. При запуску автоматично виконується синхронізація схеми бази даних (prisma db push).
     База даних PostgreSQL 15 піднімається у власному контейнері (postgres) із стандартними налаштуваннями користувача та пароля, з базою smart_lock. Її дані зберігаються у Docker volume postgres_data, що забезпечує персистентність облікових записів, історії подій та налаштувань пристроїв навіть після видалення контейнера. База слухає порт 5432 та доступна іншим сервісам у мережі.
     Другий компонент - це MQTT-брокер (mosquitto) на основі образу eclipse-mosquitto:2. Він виступає центральним вузлом комунікації, забезпечуючи миттєву передачу команд відкриття/закриття та отримання телеметрії. Брокер налаштований слухати зовнішні підключення на порту 1883 (директива listener 1883 0.0.0.0 у конфігурації), що критично важливо для роботи в Docker-середовищі. Конфігурація зберігається у монтуваному файлі mosquitto.conf, а логи виводятся у стандартний потік (stdout) для зручності діагностики.
     Третій компонент - IoT-клієнт (iot-client), реалізований на Python (образ python:3.9-slim). Він емулює роботу розумного замка та датчика руху, включаючи фізику розряду батареї та локальну валідацію TOTP-кодів. Контейнер встановлює необхідні залежності (paho-mqtt, pyotp) і запускає скрипт main.py у режимі без буферизації виводу (PYTHONUNBUFFERED=1), що дозволяє бачити логи симуляції в реальному часі. Клієнт підключається до брокера, підписується на топіки команд (locks/.../command) та публікує телеметрію. Для локального аудиту та налагодження алгоритмів використовується монтування файлу local_iot_data.csv, куди записується історія всіх станів та аномалій.
     Node.js контейнер використовує оптимізований процес запуску: спершу копіюються файли залежностей package.json та схема Prisma, виконується встановлення пакетів та генерація клієнта (prisma generate), і лише потім копіюється код додатку.
     Мережа smart-lock-net об'єднує всі компоненти, дозволяючи API звертатися до брокера за ім'ям хоста mosquitto, а до бази як postgres, що забезпечує ізоляцію від зовнішнього середовища та спрощує конфігурацію.
     Система дозволяє розгортання повнофункціонального середовища контролю доступу однією командою. Вона підтримує автоматичну ініціалізацію даних (Seeding) через запуск скрипта prisma/seed.js всередині контейнера API, що створює необхідних адміністраторів та тестові пристрої. Архітектура є стійкою до збоїв: механізми Healthcheck для бази даних та Retry Loop для MQTT-клієнтів гарантують автоматичне відновлення зв'язку при перезапуску окремих сервісів.


4 ВИСНОВКИ
     
     У рамках лабораторної роботи розгорнуто комплексну програмну систему Smart Lock, що складається з серверної частини, емулятора IoT-пристроїв, реляційної бази даних та MQTT-брокера. Система була успішно налаштована, запущена в контейнеризованому середовищі та перевірена на коректність двосторонньої взаємодії між усіма компонентами.
     Backend на Node.js працює як центральний API-шлюз, забезпечуючи валідацію доступу та збереження даних у PostgreSQL з підтримкою персистентності через Docker volume. MQTT-брокер Mosquitto виступає надійною транспортною шиною, гарантуючи миттєву доставку команд керування та отримання телеметрії. Python-клієнт виконує роль повноцінного цифрового двійника "розумного замка", генеруючи реалістичні дані про стан батареї та фізику механізму, що дозволило протестувати алгоритми виявлення аномалій та логіку офлайн-доступу (TOTP) без використання реального заліза.
     Використання Docker Compose та спільної віртуальної мережі забезпечило ізольовану, стабільну та легко відтворювану інфраструктуру. Автоматизація процесу ініціалізації бази даних та механізми автоматичного перепідключення у клієнтських сервісах значно спростили розгортання та підвищили стійкість системи до збоїв.
     Система продемонструвала високу модульність та готовність до масштабування: додавання нових типів датчиків або розширення логіки аналітики можливе без зупинки основних сервісів. Всі цілі лабораторної роботи були досягнуті: реалізовано безпечне середовище виконання, перевірено стабільність зв'язку та продемонстровано повний цикл керування доступом.



ДОДАТОК А

Docker-compose.yml для системи

1. version: '3.8'
2. 
3. services:
4.   postgres:
5.     image: postgres:15-alpine
6.     container_name: smart_lock_db
7.     environment:
8.       POSTGRES_USER: admin
9.       POSTGRES_PASSWORD: secure_password
10.       POSTGRES_DB: smart_lock
11.     ports:
12.       - "5432:5432"
13.     volumes:
14.       - postgres_data:/var/lib/postgresql/data
15.     networks:
16.       - smart-lock-net
17.     healthcheck:
18.       test: ["CMD-SHELL", "pg_isready -U admin -d smart_lock"]
19.       interval: 5s
20.       timeout: 5s
21.       retries: 5
22. 
23.   mosquitto:
24.     image: eclipse-mosquitto:2
25.     container_name: smart_lock_mqtt
26.     ports:
27.       - "1883:1883"
28.       - "9001:9001"
29.     volumes:
30.       - ./mosquitto/config:/mosquitto/config
31.       - ./mosquitto/data:/mosquitto/data
32.       - ./mosquitto/log:/mosquitto/log
33.     networks:
34.       - smart-lock-net
35. 
36.   api:
37.     build: ./smart-lock-api
38.     container_name: smart_lock_api
39.     ports:
40.       - "3000:3000"
41.     environment:
42.       DATABASE_URL: "postgresql://admin:secure_password@postgres:5432/smart_lock?schema=public"
43.       MQTT_BROKER_URL: "mqtt://mosquitto:1883"
44.       JWT_SECRET: "docker_super_secret_key"
45.       PORT: 3000
46.     depends_on:
47.       postgres:
48.         condition: service_healthy
49.       mosquitto:
50.         condition: service_started
51.     networks:
52.       - smart-lock-net
53. 
54.   iot-client:
55.     build: ./smart-lock-iot-client
56.     container_name: smart_lock_iot
57.     environment:
58.       MQTT_BROKER: "mosquitto" 
59.       MQTT_PORT: 1883
60.       LOCK_SERIAL: "SN-12345"
61.       SENSOR_SERIAL: "SN-SENSOR-01"
62.       DEVICE_SECRET: "BQ3V4P32DUJVWZCE"
63.     depends_on:
64.       - api
65.     networks:
66.       - smart-lock-net
67. 
68. networks:
69.   smart-lock-net:
70.     driver: bridge
71. 
72. volumes:
73.   postgres_data:
2


